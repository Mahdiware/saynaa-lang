name: CI

on: [push, pull_request, workflow_dispatch]

jobs:
  style-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run static checks.
        run: python3 util/check.py

  linux-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install PCRE2
        run: |
          sudo apt-get update
          sudo apt-get install -y libpcre2-dev
      - name: Run the Makefile.
        run: make all
      - name: Run tests.
        run: python3 util/test.py
      - uses: actions/upload-artifact@v4
        with:
          name: saynaa-linux
          path: saynaa

  windows-build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install PCRE2 (Regex Dependency)
        run: |
          # 1. Install the static library
          vcpkg install pcre2:x64-windows-static
          
          # 2. Create the deps folder structure
          New-Item -ItemType Directory -Force -Path deps/pcre2/include
          New-Item -ItemType Directory -Force -Path deps/pcre2/lib
          
          # 3. Copy files using PowerShell (safer with Windows paths)
          $vcpkgRoot = $env:VCPKG_INSTALLATION_ROOT
          Copy-Item "$vcpkgRoot/installed/x64-windows-static/include/pcre2*" -Destination "deps/pcre2/include/"
          Copy-Item "$vcpkgRoot/installed/x64-windows-static/lib/pcre2-8-static.lib" -Destination "deps/pcre2/lib/"
        shell: pwsh

      - name: Run build batch script.
        run: cmd /c build.bat

      - name: Run tests.
        run: python util/test.py
        
      - uses: actions/upload-artifact@v4
        with:
          name: saynaa-windows
          path: saynaa.exe

  macos-build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install PCRE2
        run: brew install pcre2
      - name: Run the Makefile.
        run: make all
      - name: Run tests.
        run: python3 util/test.py
      - uses: actions/upload-artifact@v4
        with:
          name: saynaa-mac
          path: saynaa
